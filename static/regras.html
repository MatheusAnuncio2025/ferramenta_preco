<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Regras</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .rules-section {
            margin-bottom: 30px;
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rules-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rules-table th,
        .rules-table td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
            vertical-align: middle;
        }

        .rules-table th {
            background-color: #f8f9fa;
            white-space: nowrap;
        }

        .rules-table input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            background-color: #f8f9fa;
        }

        .rules-table tr.is-editing input {
            background-color: var(--white-color);
        }

        .actions-cell {
            text-align: center;
            width: 150px;
            white-space: nowrap;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            font-weight: 500;
            margin: 0 2px;
        }
        .edit-btn { background-color: var(--secondary-color); color: white; }
        .save-btn { background-color: var(--primary-color); color: white; }
        .cancel-btn { background-color: #f0f2f5; }
        .delete-btn { background-color: var(--danger-color); color: white; }

    </style>
</head>

<body>
    <div class="top-green-bar"></div>
    <nav class="main-nav">
        <a href="/alertas" id="alertas-link" class="nav-item hidden">Dashboard de Alertas</a>
        <a href="/calculadora" class="nav-item">Calcular Preço</a>
        <a href="/lista" class="nav-item">Consultar Precificações</a>
        <a href="/configuracoes" class="nav-item">Configurações</a>
        <a href="/regras" id="regras-link" class="nav-item hidden">Gerenciar Regras</a>
        <a href="/campanhas" id="campanhas-link" class="nav-item hidden">Gerenciar Campanhas</a>
        <a href="/historico" id="historico-link" class="nav-item hidden">Histórico</a>
        <a href="/perfil" class="nav-item">Meu Perfil</a>
        <a href="/admin" id="admin-link" class="nav-item hidden">Admin</a>
    </nav>
    <div class="container">
        <div class="header">
            <h1>Gerenciamento de Regras de Negócio</h1>
            <div id="auth-container" class="auth-container hidden">
                <img id="profile-pic" src="" alt="Foto do Perfil" class="profile-pic">
                <span id="user-info" class="user-greeting"></span>
                <button id="logout-btn" class="app-button auth-button logout">Logout</button>
            </div>
        </div>

        <div id="loader" class="form-section" style="text-align: center;">
            <p>Carregando regras... <span class="loader-spinner"></span></p>
        </div>

        <div id="rules-content" class="hidden">
            <div class="form-section rules-section">
                <div class="rules-header">
                    <h3>Regras de Tarifa Fixa (Mercado Livre)</h3>
                    <button id="add-tarifa-fixa-btn" class="app-button" style="background-color: var(--secondary-color);">+ Adicionar</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="rules-table" id="tarifa-fixa-table">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Venda Mín. (R$)</th>
                                <th>Venda Máx. (R$)</th>
                                <th>Taxa Fixa (R$)</th>
                                <th>Taxa (%)</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="form-section rules-section">
                <div class="rules-header">
                    <h3>Categorias de Precificação</h3>
                    <button id="add-categoria-btn" class="app-button" style="background-color: var(--secondary-color);">+ Adicionar</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="rules-table" id="categorias-table">
                        <thead>
                            <tr>
                                <th>Nome da Categoria</th>
                                <th>Margem Padrão (%)</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="form-section rules-section">
                <div class="rules-header">
                    <h3>Regras de Frete (Mercado Livre)</h3>
                    <button id="add-frete-btn" class="app-button" style="background-color: var(--secondary-color);">+ Adicionar</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="rules-table" id="frete-table">
                        <thead>
                            <tr>
                                <th>Venda Mín. (R$)</th>
                                <th>Venda Máx. (R$)</th>
                                <th>Peso Mín. (g)</th>
                                <th>Peso Máx. (g)</th>
                                <th>Custo Frete (R$)</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="app-modal" class="modal-overlay"></div>

    <script src="/static/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatusAndUpdateNav().then(user => {
                if (user) {
                    try {
                        const loader = document.getElementById('loader');
                        const content = document.getElementById('rules-content');
                        
                        const ruleManager = (config) => {
                            const tableBody = document.getElementById(config.tableId).querySelector('tbody');
                            
                            const getRowData = (row) => {
                                const data = { id: row.dataset.id || null };
                                config.fields.forEach(field => {
                                    const input = row.querySelector(`[data-field="${field.name}"]`);
                                    const value = input.value.trim();
                                    data[field.name] = value === '' ? null : (field.type === 'number' ? parseFloat(value) : value);
                                });
                                return data;
                            };

                            const createRow = (data = {}) => {
                                const tr = document.createElement('tr');
                                tr.dataset.id = data.id || '';
                                let cellsHtml = '';
                                config.fields.forEach(f => {
                                    cellsHtml += `<td><input type="${f.type}" step="0.01" class="rule-input" data-field="${f.name}" placeholder="${f.placeholder || ''}" readonly></td>`;
                                });
                                cellsHtml += `<td class="actions-cell"></td>`;
                                tr.innerHTML = cellsHtml;
                                
                                Object.keys(data).forEach(key => {
                                    const input = tr.querySelector(`[data-field="${key}"]`);
                                    if(input) input.value = data[key] === null || data[key] === undefined ? '' : data[key];
                                });

                                return tr;
                            };

                            const setViewState = (row) => {
                                row.classList.remove('is-editing');
                                row.querySelectorAll('.rule-input').forEach(i => i.readOnly = true);
                                const actionsCell = row.querySelector('.actions-cell');
                                actionsCell.innerHTML = `
                                    <button class="action-btn edit-btn">Editar</button>
                                    <button class="action-btn delete-btn">Excluir</button>
                                `;
                            };

                            const setEditState = (row) => {
                                row.classList.add('is-editing');
                                const originalData = {};
                                row.querySelectorAll('.rule-input').forEach(i => {
                                    i.readOnly = false;
                                    originalData[i.dataset.field] = i.value;
                                });
                                row.dataset.original = JSON.stringify(originalData);
                                const actionsCell = row.querySelector('.actions-cell');
                                actionsCell.innerHTML = `
                                    <button class="action-btn save-btn">Salvar</button>
                                    <button class="action-btn cancel-btn">Cancelar</button>
                                `;
                            };

                            const handleSave = async (row) => {
                                const data = getRowData(row);
                                const isNew = !data.id;
                                const url = isNew ? config.endpoint : `${config.endpoint}/${data.id}`;
                                const method = isNew ? 'POST' : 'PUT';
                                
                                row.style.opacity = '0.5';
                                try {
                                    const response = await fetch(url, {
                                        method,
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(data)
                                    });
                                    if (!response.ok) throw new Error((await response.json()).detail || 'Erro no servidor.');
                                    
                                    const savedData = await response.json();
                                    row.dataset.id = savedData.id;
                                    setViewState(row);
                                } catch (error) {
                                    showAppModal({ title: "Erro ao Salvar", bodyHtml: `<p>${error.message}</p>`, buttons: [{ text: "OK" }] });
                                    handleCancel(row); // Reverte para o estado original
                                } finally {
                                    row.style.opacity = '1';
                                }
                            };
                            
                            const handleCancel = (row) => {
                                if (!row.dataset.id) { // Se for uma linha nova, remove
                                    row.remove();
                                    return;
                                }
                                const originalData = JSON.parse(row.dataset.original);
                                Object.keys(originalData).forEach(key => {
                                    row.querySelector(`[data-field="${key}"]`).value = originalData[key];
                                });
                                setViewState(row);
                            };

                            const handleDelete = async (row) => {
                                showAppModal({
                                    title: "Confirmar Exclusão",
                                    bodyHtml: "<p>Tem certeza que deseja excluir esta regra?</p>",
                                    buttons: [
                                        { text: "Cancelar", class: "secondary" },
                                        {
                                            text: "Confirmar", class: "delete",
                                            onClick: async () => {
                                                row.style.opacity = '0.5';
                                                try {
                                                    const response = await fetch(`${config.endpoint}/${row.dataset.id}`, { method: 'DELETE' });
                                                    if (!response.ok) throw new Error('Falha ao excluir.');
                                                    row.remove();
                                                } catch(e) {
                                                    showAppModal({ title: "Erro", bodyHtml: `<p>${e.message}</p>`, buttons: [{ text: "OK" }] });
                                                    row.style.opacity = '1';
                                                }
                                            }
                                        }
                                    ]
                                });
                            };

                            tableBody.addEventListener('click', (e) => {
                                const row = e.target.closest('tr');
                                if (!row) return;

                                if (e.target.classList.contains('edit-btn')) setEditState(row);
                                else if (e.target.classList.contains('save-btn')) handleSave(row);
                                else if (e.target.classList.contains('cancel-btn')) handleCancel(row);
                                else if (e.target.classList.contains('delete-btn')) handleDelete(row);
                            });

                            document.getElementById(config.addBtnId).addEventListener('click', () => {
                                const newRow = createRow();
                                tableBody.appendChild(newRow);
                                setEditState(newRow);
                                newRow.querySelector('.rule-input').focus();
                            });
                            
                            return (data) => { // Render function
                                tableBody.innerHTML = '';
                                data.forEach(item => {
                                    const row = createRow(item);
                                    setViewState(row);
                                    tableBody.appendChild(row);
                                });
                            };
                        };

                        const configs = {
                            tarifaFixa: {
                                tableId: 'tarifa-fixa-table', addBtnId: 'add-tarifa-fixa-btn', endpoint: '/api/regras-negocio/tarifa-fixa',
                                fields: [
                                    { name: 'descricao', type: 'text' }, { name: 'min_venda', type: 'number' }, { name: 'max_venda', type: 'number' },
                                    { name: 'taxa_fixa', type: 'number' }, { name: 'taxa_percentual', type: 'number' }
                                ]
                            },
                            categorias: {
                                tableId: 'categorias-table', addBtnId: 'add-categoria-btn', endpoint: '/api/regras-negocio/categorias',
                                fields: [{ name: 'nome', type: 'text' }, { name: 'margem_padrao', type: 'number' }]
                            },
                            frete: {
                                tableId: 'frete-table', addBtnId: 'add-frete-btn', endpoint: '/api/regras-negocio/frete',
                                fields: [
                                    { name: 'min_venda', type: 'number' }, { name: 'max_venda', type: 'number' }, { name: 'min_peso_g', type: 'number' },
                                    { name: 'max_peso_g', type: 'number' }, { name: 'custo_frete', type: 'number' }
                                ]
                            }
                        };
                        
                        const renderers = {
                            tarifaFixa: ruleManager(configs.tarifaFixa),
                            categorias: ruleManager(configs.categorias),
                            frete: ruleManager(configs.frete)
                        };

                        const loadRules = async () => {
                            try {
                                const response = await fetch('/api/regras-negocio');
                                if (!response.ok) throw new Error('Falha ao carregar regras.');
                                const data = await response.json();
                                renderers.tarifaFixa(data.REGRAS_TARIFA_FIXA_ML);
                                renderers.categorias(data.CATEGORIAS_PRECIFICACAO);
                                renderers.frete(data.REGRAS_FRETE_ML);
                                loader.classList.add('hidden');
                                content.classList.remove('hidden');
                            } catch (error) {
                                loader.innerHTML = `<p class="text-danger">${error.message}</p>`;
                            }
                        };

                        setupLogoutButton();
                        loadRules().then(() => {
                            if (user.role !== 'admin') {
                                Object.values(configs).forEach(c => document.getElementById(c.addBtnId).style.display = 'none');
                                document.querySelectorAll('.actions-cell').forEach(cell => cell.style.display = 'none');
                            }
                        });

                    } catch (error) {
                        console.error("Erro ao inicializar a página de regras:", error);
                        const container = document.querySelector('.container');
                        if (container) {
                            container.innerHTML = '<h1>Ocorreu um erro ao carregar a página.</h1><p>Por favor, tente recarregar ou contate o suporte. Detalhes do erro foram registrados no console.</p>';
                        }
                    }
                }
            });
        });
    </script>
</body>

</html>