<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administração</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="navbar-left">
      <a class="brand" href="/">Ferramenta de Precificação</a>
      <nav class="navbar-links"><!-- preenchido via app.js --></nav>
    </div>
    <div class="navbar-right" id="auth-container">
      <img id="profile-pic" class="avatar" alt="Avatar" />
      <span id="user-info"></span>
      <button id="logout-btn" class="app-button danger small">Logout</button>
    </div>
  </header>

  <main class="page">
    <h1>Administração</h1>

    <section class="card">
      <div class="card-header">
        <h2>Usuários</h2>
        <div class="actions">
          <button id="btn-reload-users" class="app-button">Recarregar</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table class="data-table" id="admin-users-table">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Autorizado</th>
              <th>Admin</th>
              <th>Último acesso</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody><!-- preenchido via JS --></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Logs Recentes</h2>
        <div class="actions">
          <button id="btn-reload-logs" class="app-button">Recarregar</button>
        </div>
      </div>
      <div id="admin-logs-list" class="log-list"><!-- logs --></div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Health</h2>
        <div class="actions">
          <button id="btn-reload-health" class="app-button">Recarregar</button>
        </div>
      </div>
      <div class="kv" id="admin-health-kv"><!-- health --></div>
    </section>
  </main>

  <div id="toast-container" class="toast-container"></div>
  <div id="app-modal" class="modal-overlay"></div>

  <script src="/static/utils.js"></script>
  <script src="/static/app.js"></script>
  <script>
    (function () {
      const $ = (sel) => document.querySelector(sel);

      async function loadUsers() {
        try {
          const res = await safeFetch("/api/admin/usuarios");
          const rows = Array.isArray(res.users) ? res.users : [];
          const tbody = $("#admin-users-table tbody");
          tbody.innerHTML = "";
          rows.forEach(u => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><img class="avatar" src="${escapeHtml(u.picture || "/static/avatar-placeholder.png")}" alt=""/></td>
              <td>${escapeHtml(u.name || "")}</td>
              <td>${escapeHtml(u.email || "")}</td>
              <td>${u.autorizado ? "Sim" : "Não"}</td>
              <td>${u.is_admin ? "Sim" : "Não"}</td>
              <td>${escapeHtml(u.last_login || "—")}</td>
              <td class="actions">
                <button class="app-button small" data-action="toggle-auth" data-email="${escapeHtml(u.email)}">${u.autorizado ? "Revogar" : "Autorizar"}</button>
                <button class="app-button small ${u.is_admin ? "warn" : "info"}" data-action="toggle-admin" data-email="${escapeHtml(u.email)}">${u.is_admin ? "Remover admin" : "Tornar admin"}</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          // delegação de eventos
          tbody.addEventListener("click", async (ev) => {
            const btn = ev.target.closest("button[data-action]");
            if (!btn) return;
            const email = btn.getAttribute("data-email");
            const action = btn.getAttribute("data-action");
            try {
              if (action === "toggle-auth") {
                const autorizado = btn.textContent.includes("Autorizar");
                await safeFetch("/api/admin/usuarios/authorize", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, autorizado })
                });
                showToast("Autorização atualizada.", "success", 1200);
                loadUsers();
              } else if (action === "toggle-admin") {
                const is_admin = btn.textContent.includes("Tornar");
                await safeFetch("/api/admin/usuarios/role", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, is_admin })
                });
                showToast("Permissão atualizada.", "success", 1200);
                loadUsers();
              }
            } catch (e) {
              showToast(e.message || "Falha ao atualizar usuário.", "error");
            }
          }, { once: true }); // reaplicado a cada load
        } catch (e) {
          showToast(e.message || "Falha ao carregar usuários.", "error");
        }
      }

      async function loadLogs() {
        try {
          const res = await safeFetch("/api/admin/logs");
          const items = Array.isArray(res.items) ? res.items : [];
          const list = $("#admin-logs-list");
          list.innerHTML = "";
          items.forEach(it => {
            const row = document.createElement("div");
            row.className = "log-row";
            row.innerHTML = `
              <span class="log-ts">${escapeHtml(it.ts || "")}</span>
              <span class="log-level">${escapeHtml(it.level || "")}</span>
              <span class="log-msg">${escapeHtml(it.message || "")}</span>
            `;
            list.appendChild(row);
          });
        } catch (e) {
          showToast(e.message || "Falha ao carregar logs.", "error");
        }
      }

      async function loadHealth() {
        try {
          const res = await safeFetch("/api/admin/health");
          const kv = $("#admin-health-kv");
          kv.innerHTML = `
            <div><span>Status:</span><strong>${escapeHtml(res.status || "—")}</strong></div>
            <div><span>Python:</span><strong>${escapeHtml(res.python || "—")}</strong></div>
            <div><span>Plataforma:</span><strong>${escapeHtml(res.platform || "—")}</strong></div>
            <div><span>App Version:</span><strong>${escapeHtml(res.app_version || "—")}</strong></div>
            <div><span>Ambiente:</span><strong>${escapeHtml(res.env || "—")}</strong></div>
          `;
        } catch (e) {
          showToast(e.message || "Falha ao carregar health.", "error");
        }
      }

      // Botões
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuthStatusAndUpdateNav();
        $("#btn-reload-users")?.addEventListener("click", (e) => { e.preventDefault(); loadUsers(); });
        $("#btn-reload-logs")?.addEventListener("click", (e) => { e.preventDefault(); loadLogs(); });
        $("#btn-reload-health")?.addEventListener("click", (e) => { e.preventDefault(); loadHealth(); });

        // primeira carga
        loadUsers();
        loadLogs();
        loadHealth();
      });
    })();
  </script>
</body>
</html>
