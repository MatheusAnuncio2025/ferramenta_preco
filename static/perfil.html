<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Perfil</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="navbar-left">
      <a class="brand" href="/">Ferramenta de Precificação</a>
      <nav class="navbar-links"><!-- preenchido via app.js --></nav>
    </div>
    <div class="navbar-right" id="auth-container">
      <img id="profile-pic" class="avatar" alt="Avatar" />
      <span id="user-info"></span>
      <button id="logout-btn" class="app-button danger small">Logout</button>
    </div>
  </header>

  <main class="page">
    <h1>Meu Perfil</h1>

    <section class="card">
      <div class="profile-header">
        <img id="perfil-foto" class="avatar xl" alt="Foto do usuário"/>
        <div>
          <h2 id="perfil-nome">—</h2>
          <p id="perfil-email" class="muted">—</p>
          <div class="chips" id="perfil-chips"><!-- roles/flags --></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Detalhes</h2>
      <div class="kv">
        <div><span>Autorizado:</span><strong id="perfil-autorizado">—</strong></div>
        <div><span>Administrador:</span><strong id="perfil-admin">—</strong></div>
        <div><span>Domínio:</span><strong id="perfil-dominio">—</strong></div>
      </div>
    </section>
  </main>

  <div id="toast-container" class="toast-container"></div>
  <div id="app-modal" class="modal-overlay"></div>

  <script src="/static/utils.js"></script>
  <script src="/static/app.js"></script>
  <script>
    (async function () {
      // espera navbar/status
      const auth = await checkAuthStatusAndUpdateNav();

      // tenta endpoint dedicado, com fallback para /api/auth/status
      let data = null;
      try {
        data = await safeFetch("/api/perfil/meus-dados");
      } catch {
        // ok, seguimos com auth.user
      }

      const user = (data && data.user) || (auth && auth.user) || {};
      const nome = user.name || user.display_name || user.email || "Usuário";
      const email = user.email || "—";
      const foto = user.picture || "";
      const roles = Array.isArray(user.roles) ? user.roles : (user.is_admin ? ["admin"] : ["user"]);
      const autorizado = !!(user.autorizado ?? user.authorized);
      const isAdmin = !!user.is_admin;

      const dominio = email.includes("@") ? email.split("@")[1] : "—";

      // preenche UI
      const $ = (sel) => document.querySelector(sel);
      $("#perfil-foto").src = foto || "/static/avatar-placeholder.png";
      $("#perfil-nome").textContent = nome;
      $("#perfil-email").textContent = email;
      $("#perfil-autorizado").textContent = autorizado ? "Sim" : "Não";
      $("#perfil-admin").textContent = isAdmin ? "Sim" : "Não";
      $("#perfil-dominio").textContent = dominio;

      const chips = $("#perfil-chips");
      chips.innerHTML = "";
      roles.forEach(r => {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = r;
        chips.appendChild(span);
      });
      if (autorizado) {
        const span = document.createElement("span");
        span.className = "chip success";
        span.textContent = "autorizado";
        chips.appendChild(span);
      } else {
        const span = document.createElement("span");
        span.className = "chip warn";
        span.textContent = "não autorizado";
        chips.appendChild(span);
      }
      if (isAdmin) {
        const span = document.createElement("span");
        span.className = "chip info";
        span.textContent = "admin";
        chips.appendChild(span);
      }
    })();
  </script>
</body>
</html>
