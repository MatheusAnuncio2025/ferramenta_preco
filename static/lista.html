<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listagem de Precificações</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            gap: 15px;
        }
        .pagination-container button {
            padding: 8px 16px;
        }
        /* Estilos para o modal de edição em massa */
        #bulk-edit-value-container .form-field {
            display: none;
        }
        #bulk-edit-value-container .form-field.active {
            display: flex;
        }
    </style>
</head>

<body>
    <div class="top-green-bar"></div>
    <nav class="main-nav">
        <a href="/alertas" id="alertas-link" class="nav-item hidden">Dashboard de Alertas</a>
        <a href="/calculadora" class="nav-item">Calcular Preço</a>
        <a href="/lista" class="nav-item">Consultar Precificações</a>
        <a href="/configuracoes" class="nav-item">Configurações</a>
        <a href="/regras" id="regras-link" class="nav-item hidden">Gerenciar Regras</a>
        <a href="/campanhas" id="campanhas-link" class="nav-item hidden">Gerenciar Campanhas</a>
        <a href="/historico" id="historico-link" class="nav-item hidden">Histórico</a>
        <a href="/perfil" class="nav-item">Meu Perfil</a>
        <a href="/admin" id="admin-link" class="nav-item hidden">Admin</a>
    </nav>
    <div class="container">
        <div class="header">
            <h1>Consultar Precificações</h1>
            <div id="auth-container" class="auth-container hidden">
                <img id="profile-pic" src="" alt="Foto do Perfil" class="profile-pic">
                <span id="user-info" class="user-greeting"></span>
                <button id="logout-btn" class="app-button auth-button logout">Logout</button>
            </div>
        </div>
    </div>

    <div class="filter-search-section">
        <div class="input-grid">
            <div class="form-group">
                <label for="lojaFilter">Loja / Marketplace</label>
                <select id="lojaFilter" class="filter-input"></select>
            </div>
            <div class="form-group">
                <label for="categoryFilter">Categoria</label>
                <select id="categoryFilter" class="filter-input"></select>
            </div>
            <div class="form-group">
                <label for="planFilter">Plano de Venda</label>
                <select id="planFilter" class="filter-input">
                    <option value="">Todos os Planos</option>
                    <option value="classico">Com Preço Clássico</option>
                    <option value="premium">Com Preço Premium</option>
                </select>
            </div>
            <div class="form-group"><label for="skuFilter">SKU</label><input type="text" id="skuFilter"
                    class="filter-input" placeholder="Filtrar por SKU..."></div>
            <div class="form-group full-width">
                <label for="tituloFilter">Título do Produto</label>
                <input type="text" id="tituloFilter" class="filter-input" placeholder="Filtrar por título...">
            </div>
        </div>
    </div>

    <div class="container">
        <div id="bulk-actions-header" class="bulk-actions-header hidden">
            <div class="selection-info">
                <input type="checkbox" id="select-all-checkbox">
                <label for="select-all-checkbox">Selecionar Todos</label>
                <span id="selection-count"></span>
            </div>
            <button id="bulk-edit-btn" class="app-button" disabled>Editar Selecionados</button>
        </div>
    </div>

    <div id="product-list-container"></div>
    
    <div id="pagination-container" class="pagination-container"></div>

    <div id="list-message-container" class="container" style="text-align: center; display: none;">
        <div class="form-section">
            <p id="list-message-text"></p>
            <span id="list-loader" class="hidden">
                <div class="loader-spinner"></div>
            </span>
        </div>
    </div>

    <template id="product-item-template">
        <div class="product-listing-item">
            <input type="checkbox" class="product-checkbox">
            <button class="action-menu-button">&vellip;</button>
            <div class="action-menu">
                <div class="action-menu-item edit">Editar</div>
                <div class="action-menu-item delete">Excluir</div>
            </div>
            <div class="product-header">
                <div class="form-group"><label>Título do Produto</label><input type="text" data-field="titulo" readonly></div>
                <div class="form-group"><label>SKU</label><input type="text" data-field="sku" readonly></div>
                <div class="form-group"><label>Marketplace / Loja</label><input type="text" data-field="marketplace_loja" readonly></div>
            </div>
            <div class="product-details">
                <div class="form-group"><label>Custo Total (R$)</label><input type="text" data-field="custo_total" readonly></div>
                <div class="form-group"><label>Venda Clássico (R$)</label><input type="text" data-field="venda_classico" readonly></div>
                <div class="form-group"><label>Margem Clássico (%)</label><input type="text" data-field="margem_classico" readonly class="margem-output"></div>
                <div class="form-group"><label>Venda Premium (R$)</label><input type="text" data-field="venda_premium" readonly></div>
                <div class="form-group"><label>Margem Premium (%)</label><input type="text" data-field="margem_premium" readonly class="margem-output"></div>
                <div class="form-group"><label>Calculado por</label><input type="text" data-field="calculado_por" readonly></div>
                <div class="form-group"><label>Data do Cálculo</label><input type="text" data-field="data_calculo" readonly></div>
            </div>
        </div>
    </template>

    <div id="app-modal" class="modal-overlay"></div>

    <script src="/static/app.js"></script>
    <script src="/static/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatusAndUpdateNav().then(user => {
                if (user) {
                    try {
                        const productListContainer = document.getElementById('product-list-container');
                        const productItemTemplate = document.getElementById('product-item-template');
                        const filterInputs = document.querySelectorAll('.filter-input');
                        const messageContainer = document.getElementById('list-message-container');
                        const bulkActionsHeader = document.getElementById('bulk-actions-header');
                        const selectAllCheckbox = document.getElementById('select-all-checkbox');
                        const selectionCount = document.getElementById('selection-count');
                        const bulkEditBtn = document.getElementById('bulk-edit-btn');
                        
                        let currentPage = 1;
                        const pageSize = 20;

                        const updateBulkActionsUI = () => { /* ...código existente... */ };
                        selectAllCheckbox.addEventListener('change', () => { /* ...código existente... */ });
                        const populateLojas = async () => { /* ...código existente... */ };
                        const populateCategorias = async () => { /* ...código existente... */ };
                        const showListMessage = (text, showLoader = false) => { /* ...código existente... */ };
                        const hideListMessage = () => { /* ...código existente... */ };
                        const renderPagination = (totalItems) => { /* ...código existente... */ };
                        const renderProducts = (products, totalItems) => { /* ...código existente... */ };
                        
                        const fetchAndRenderProducts = async () => {
                            showListMessage('Buscando precificações...', true);
                            
                            const params = new URLSearchParams({
                                page: currentPage,
                                page_size: pageSize,
                                sku: document.getElementById('skuFilter').value,
                                titulo: document.getElementById('tituloFilter').value,
                                plano: document.getElementById('planFilter').value,
                                categoria: document.getElementById('categoryFilter').value
                            });

                            const lojaValue = document.getElementById('lojaFilter').value;
                            if (lojaValue) {
                                const [marketplace, id_loja] = lojaValue.split('|');
                                params.append('marketplace', marketplace);
                                params.append('id_loja', id_loja);
                            }

                            try {
                                // CORREÇÃO: O endpoint correto, conforme o router atualizado, é /api/precificacao
                                const response = await fetch(`/api/precificacao?${params.toString()}`);
                                const data = await response.json();
                                if (!response.ok) throw new Error(data.detail || 'Erro ao buscar dados.');
                                renderProducts(data.items, data.total_items);
                            } catch (error) {
                                showListMessage(`Erro: ${error.message}`);
                            }
                        };
                        
                        // LÓGICA PARA O MODAL DE EDIÇÃO EM MASSA
                        bulkEditBtn.addEventListener('click', () => {
                            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
                            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.closest('.product-listing-item').dataset.id);

                            // Popula o select de categorias dinamicamente
                            const categoryFilter = document.getElementById('categoryFilter');
                            let categoryOptionsHtml = categoryFilter.innerHTML;

                            const modalBody = `
                                <div class="form-field">
                                    <label for="bulk-edit-action">Ação a ser aplicada</label>
                                    <select id="bulk-edit-action" class="form-field">
                                        <option value="">Selecione...</option>
                                        <option value="set_custo_unitario">Definir Custo Unitário</option>
                                        <option value="set_categoria">Definir Categoria</option>
                                    </select>
                                </div>
                                <div id="bulk-edit-value-container">
                                    <div class="form-field" data-action="set_custo_unitario">
                                        <label for="bulk-edit-custo">Novo Custo (R$)</label>
                                        <input type="number" step="0.01" id="bulk-edit-custo" class="form-field">
                                    </div>
                                    <div class="form-field" data-action="set_categoria">
                                        <label for="bulk-edit-categoria">Nova Categoria</label>
                                        <select id="bulk-edit-categoria" class="form-field">${categoryOptionsHtml}</select>
                                    </div>
                                </div>
                            `;

                            showAppModal({
                                title: `Editar ${selectedIds.length} Itens`,
                                bodyHtml: modalBody,
                                buttons: [
                                    { text: 'Cancelar', class: 'secondary' },
                                    { 
                                        text: 'Aplicar Alterações', 
                                        class: 'primary', 
                                        onClick: async (button) => {
                                            const action = document.getElementById('bulk-edit-action').value;
                                            if (!action) {
                                                showToast('Por favor, selecione uma ação.', 'error');
                                                return false;
                                            }
                                            
                                            let value;
                                            if (action === 'set_custo_unitario') {
                                                value = parseFloat(document.getElementById('bulk-edit-custo').value);
                                            } else if (action === 'set_categoria') {
                                                const select = document.getElementById('bulk-edit-categoria');
                                                value = select.options[select.selectedIndex].text;
                                            }

                                            if (value === null || value === '' || (typeof value === 'number' && isNaN(value))) {
                                                showToast('Por favor, forneça um valor válido.', 'error');
                                                return false;
                                            }

                                            const payload = { ids: selectedIds, action, value };
                                            
                                            button.classList.add('is-loading');
                                            button.disabled = true;

                                            try {
                                                // CORREÇÃO: Endpoint correto para bulk-update
                                                const response = await fetch('/api/precificacao/bulk-update', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(payload)
                                                });
                                                const result = await response.json();
                                                if (!response.ok) throw new Error(result.detail || 'Erro no servidor.');
                                                
                                                showToast(result.message);
                                                fetchAndRenderProducts(); // Recarrega a lista
                                                return true; // Fecha o modal
                                            } catch (error) {
                                                showToast(error.message, 'error');
                                                button.classList.remove('is-loading');
                                                button.disabled = false;
                                                return false;
                                            }
                                        } 
                                    }
                                ]
                            });

                            // Lógica para mostrar o campo de valor correto
                            document.getElementById('bulk-edit-action').addEventListener('change', (e) => {
                                const selectedAction = e.target.value;
                                document.querySelectorAll('#bulk-edit-value-container .form-field').forEach(field => {
                                    field.classList.toggle('active', field.dataset.action === selectedAction);
                                });
                            });
                        });
                        
                        filterInputs.forEach(input => { /* ...código existente... */ });
                        productListContainer.addEventListener('change', (e) => { /* ...código existente... */ });
                        productListContainer.addEventListener('click', async (e) => { /* ...código existente... */ });
                        document.addEventListener('click', (e) => { /* ...código existente... */ });

                        setupLogoutButton();
                        populateLojas();
                        populateCategorias();
                        fetchAndRenderProducts();
                    } catch (error) {
                        console.error("Erro ao inicializar a página de lista:", error);
                    }
                }
            });
        });
    </script>
</body>

</html>